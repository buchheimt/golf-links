$(document).on("turbolinks:load", function() {
  $("#prevBtn").click(getPrev);
  $("#nextBtn").click(getNext);
});

const updateCourseShow = (course) => {
  $(".course-main").fadeOut('fast', function() {
    setField("location", course);
    setField("par", course);
    setField("length", course);
    setField("price", course);
    setField("name", course);
    setField("description", course);

    let imageResource;
    if (course.get_image === "course-default.jpg") {
      imageResource = "<%= asset_path('course-default.jpg') %>";
    } else {
      imageResource = course.get_image;
    }
    $("#coursePic").attr("src", imageResource);

    $(".course-main").fadeIn('fast');

    loadTeeTimes(course.tee_times);
  });



  $("#courseEditBtn").attr("href", course.id + "/edit")
  $("#createTeeTimeBtn").attr("href", course.id + "/tee_times/new")
  $("#prevBtn").data("id", course.id);
  $("#nextBtn").data("id", course.id);

}

const getPrev = () => {
  const currId = $("#prevBtn").data("id");
  $.get("/courses/" + currId + "/prev", function(course) {
    updateCourseShow(course);
  });
}

const getNext = () => {
  const currId = $("#nextBtn").data("id");
  $.get("/courses/" + currId + "/next", function(course) {
    updateCourseShow(course);
  });
}

const setField = (field, course) => {
  $("#" + field + "Container").show();
  value = course[field]
  if (value === null) {
    value = "";
    $("#" + field + "Container").hide();
  }
  $("#" + field).text(value);
}

const loadTeeTimes = (teeTimes) => {
  if ($("#teeTimeCards div").length > 0) {
    $("#teeTimeCards div").fadeOut("fast", function() {
      loadEachTeeTime(teeTimes);
    });
  } else {
    loadEachTeeTime(teeTimes);
  }
}

const loadEachTeeTime = (teeTimes) => {
  const templateSource = $("#tee-time-template").html();
  const template = Handlebars.compile(templateSource);
  $("#teeTimeCards").empty();
  teeTimes.forEach(function(teeTime) {
    if (teeTime.active) {
      const $teeTimeDiv = $(template(teeTime));
      $("#teeTimeCards").append($teeTimeDiv);
      if (!teeTime['available?']) {
        $teeTimeDiv.children("div").addClass("tee-time-unjoinable");
      }
      if ($(".nav-user-card")[0]) {
        const userMatch = teeTime.user_tee_times.find(function(el) {
          return el.user_id === $(".nav-user-card").data("id");
        });
        if (userMatch) {
          $teeTimeDiv.find(".joined-marker").show();
        }
      }
    }
  });
  $("#teeTimeCards").fadeIn('fast')
}
